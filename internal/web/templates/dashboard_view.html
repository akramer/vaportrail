{{template "header" .}}

<div class="dashboard-header">
    <h1>View Dashboards</h1>
    <div class="dashboard-controls">
        <label for="dashboard-select">Dashboard:</label>
        <select id="dashboard-select" onchange="loadSelectedDashboard()">
            <option value="">-- Select a Dashboard --</option>
        </select>
        <button onclick="editDashboard()" id="edit-btn" style="display:none;">Edit</button>
        <button onclick="deleteDashboard()" id="delete-btn" style="display:none;">Delete</button>
        <a href="/dashboards/create" class="btn-create">+ Create New</a>
    </div>
</div>

<div class="time-controls" style="display:none;" id="time-controls">
    <span>Presets:</span>
    <button onclick="setRange('1h')">Last 1h</button>
    <button onclick="setRange('24h')">Last 24h</button>
    <button onclick="setRange('7d')">Last 7d</button>
    <button onclick="setRange('30d')">Last 30d</button>

    <span style="margin-left: 20px;">Range:</span>
    <input type="datetime-local" id="start-time">
    <span>to</span>
    <input type="datetime-local" id="end-time">
    <button onclick="updateAllGraphs()">Go</button>

    <span style="margin-left: 20px;">Graph Mode:</span>
    <select id="graph-mode" onchange="changeGraphMode(this.value)">
        <option value="heatmap">Heatmap</option>
        <option value="line">Line Chart</option>
    </select>
    <span style="margin-left: 20px;">
        <input type="checkbox" id="log-scale" onchange="updateAllGraphs()">
        <label for="log-scale">Log Scale</label>
    </span>
</div>

<div id="public-link-banner"
    style="display:none; margin-bottom: 15px; padding: 10px 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px;">
    <span>ðŸ“¢ This dashboard is public: </span>
    <a id="public-link" href="" target="_blank" style="font-weight: bold;"></a>
</div>

<div id="graphs-container"></div>

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .dashboard-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .dashboard-controls select {
        padding: 5px 10px;
        min-width: 200px;
    }

    .btn-create {
        background: #28a745;
        color: white;
        padding: 8px 15px;
        text-decoration: none;
        border-radius: 4px;
    }

    .time-controls {
        margin-bottom: 20px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
    }

    .time-controls button {
        margin-right: 5px;
    }

    .graph-card {
        border: 1px solid #ddd;
        margin-bottom: 20px;
        border-radius: 4px;
        background: white;
    }

    .graph-card h3 {
        margin: 0;
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
    }

    .graph-chart-container {
        position: relative;
        height: 300px;
        padding: 10px;
    }

    #tooltip-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        pointer-events: none;
        font-family: monospace;
        font-size: 12px;
        z-index: 100;
        display: none;
        min-width: 150px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
</style>

<script>
    let dashboards = [];
    let currentDashboardId = null;
    let currentGraphMode = 'heatmap';
    let chartInstances = {};

    function toLocalISO(d) {
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().slice(0, 16);
    }

    function setInputs(start, end) {
        document.getElementById('start-time').value = toLocalISO(start);
        document.getElementById('end-time').value = toLocalISO(end);
    }

    function getInputs() {
        const s = document.getElementById('start-time').value;
        const e = document.getElementById('end-time').value;
        if (s && e) {
            return { start: new Date(s), end: new Date(e) };
        }
        return null;
    }

    function setRange(range) {
        const end = new Date();
        let start = new Date();
        switch (range) {
            case '1h': start.setTime(end.getTime() - 1 * 60 * 60 * 1000); break;
            case '24h': start.setTime(end.getTime() - 24 * 60 * 60 * 1000); break;
            case '7d': start.setTime(end.getTime() - 7 * 24 * 60 * 60 * 1000); break;
            case '30d': start.setTime(end.getTime() - 30 * 24 * 60 * 60 * 1000); break;
        }
        setInputs(start, end);
        updateAllGraphs();
    }

    function changeGraphMode(mode) {
        currentGraphMode = mode;
        updateAllGraphs();
    }

    async function init() {
        // Initialize time range
        const urlParams = VaporTrail.getTimeParamsFromURL();
        if (urlParams) {
            setInputs(urlParams.start, urlParams.end);
        } else {
            // Default to last 1h
            const end = new Date();
            const start = new Date(end.getTime() - 60 * 60 * 1000);
            setInputs(start, end);
        }

        // Initialize targets map (populated from graph data)
        window.targetsMap = {};

        // Load dashboards
        const res = await fetch('/api/dashboards');
        dashboards = await res.json() || [];

        const select = document.getElementById('dashboard-select');
        for (const d of dashboards) {
            const opt = document.createElement('option');
            opt.value = d.ID;
            opt.textContent = d.Name;
            select.appendChild(opt);
        }

        // Check if a dashboard is specified in URL
        const params = new URLSearchParams(window.location.search);
        const dashboardId = params.get('id');
        if (dashboardId) {
            select.value = dashboardId;
            loadSelectedDashboard();
        }
    }

    async function loadSelectedDashboard() {
        const select = document.getElementById('dashboard-select');
        const dashboardId = parseInt(select.value);

        if (!dashboardId) {
            document.getElementById('graphs-container').innerHTML = '';
            document.getElementById('time-controls').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('delete-btn').style.display = 'none';
            return;
        }

        currentDashboardId = dashboardId;
        document.getElementById('time-controls').style.display = 'block';
        document.getElementById('edit-btn').style.display = 'inline-block';
        document.getElementById('delete-btn').style.display = 'inline-block';

        // Check if dashboard is public and show link
        const dashboard = dashboards.find(d => d.ID === dashboardId);
        const publicBanner = document.getElementById('public-link-banner');
        if (dashboard && dashboard.IsPublic && dashboard.PublicSlug) {
            const publicUrl = window.location.origin + '/public/' + dashboard.PublicSlug;
            document.getElementById('public-link').href = publicUrl;
            document.getElementById('public-link').textContent = publicUrl;
            publicBanner.style.display = 'block';
        } else {
            publicBanner.style.display = 'none';
        }

        // Update URL (preserve time params if they exist)
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('id', dashboardId);
        // Ensure we don't lose start/end if they are already in the URL or inputs
        const range = getInputs();
        if (range) {
            currentUrl.searchParams.set('start', range.start.toISOString());
            currentUrl.searchParams.set('end', range.end.toISOString());
        }
        history.pushState(null, '', currentUrl);

        // Load graphs
        const res = await fetch(`/api/dashboards/${dashboardId}/graphs`);
        const graphs = await res.json() || [];

        // Populate targetsMap from graph data
        for (const graph of graphs) {
            if (graph.TargetNames) {
                for (const [id, name] of Object.entries(graph.TargetNames)) {
                    window.targetsMap[id] = name;
                }
            }
        }

        const container = document.getElementById('graphs-container');
        container.innerHTML = '';

        // Destroy existing chart instances
        for (const key in chartInstances) {
            if (chartInstances[key]) {
                chartInstances[key].destroy();
            }
        }
        chartInstances = {};

        for (const graph of graphs) {
            const div = document.createElement('div');
            div.className = 'graph-card';
            div.innerHTML = `
                <h3>${graph.Title}</h3>
                <div class="graph-chart-container" style="position: relative;">
                    <div id="tooltip-${graph.ID}" class="tooltip-overlay" style="position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px; border-radius: 5px; pointer-events: none; font-family: monospace; font-size: 12px; z-index: 100; display: none; min-width: 150px;"></div>
                    <canvas id="chart-${graph.ID}"></canvas>
                </div>
            `;
            container.appendChild(div);

            // Load chart for this graph
            loadGraphChart(graph);
        }

        if (graphs.length === 0) {
            container.innerHTML = '<p>No graphs in this dashboard. <a href="/dashboards/create?id=' + dashboardId + '">Add some graphs</a>.</p>';
        }
    }

    async function loadGraphChart(graph, enableAnimation = true) {
        const range = getInputs();
        if (!range) return;

        const targetIds = graph.TargetIDs || [];
        if (targetIds.length === 0) return;

        // Fetch data for all targets
        const allData = [];
        for (const targetId of targetIds) {
            const url = `/api/results/${targetId}?start=${range.start.toISOString()}&end=${range.end.toISOString()}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data) {
                allData.push({ targetId, data });
            }
        }

        const canvasId = `chart-${graph.ID}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        if (chartInstances[graph.ID]) {
            chartInstances[graph.ID].destroy();
        }

        const useLogScale = document.getElementById('log-scale').checked;

        chartInstances[graph.ID] = VaporTrail.renderLatencyChart({
            canvas: canvas,
            data: allData,
            range: range,
            mode: currentGraphMode,
            useLogScale: useLogScale,
            multiTarget: true,
            targetsMap: window.targetsMap,
            animate: enableAnimation,
            onZoomComplete: function (start, end) {
                setInputs(start, end);
                VaporTrail.updateURLTimeParams(start, end); // NOTE: updateAllGraphs handles full state push, but this helper is convenient if we just wanted time.
                // However, updateAllGraphs handles ID preservation too.
                updateAllGraphs(false);
            }
        });
    }

    async function updateAllGraphs(enableAnimation = true) {
        if (!currentDashboardId) return;

        // Sync to URL
        const range = getInputs();
        if (range) {
            // Preserve dashboard ID in URL
            const url = new URL(window.location);
            url.searchParams.set('id', currentDashboardId);
            url.searchParams.set('start', range.start.toISOString());
            url.searchParams.set('end', range.end.toISOString());
            window.history.pushState({}, '', url);
        }

        const res = await fetch(`/api/dashboards/${currentDashboardId}/graphs`);
        const graphs = await res.json() || [];
        for (const graph of graphs) {
            loadGraphChart(graph, enableAnimation);
        }
    }

    function editDashboard() {
        if (currentDashboardId) {
            window.location.href = '/dashboards/create?id=' + currentDashboardId;
        }
    }

    async function deleteDashboard() {
        if (!currentDashboardId) return;
        if (!confirm('Are you sure you want to delete this dashboard?')) return;

        await fetch(`/api/dashboards/${currentDashboardId}`, { method: 'DELETE' });
        window.location.href = '/dashboards/view';
    }

    init();
</script>

{{template "footer" .}}