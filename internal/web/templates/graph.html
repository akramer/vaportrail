{{template "header" .}}

<h1>{{.Name}}</h1>
<p>
    <strong>Address:</strong> {{.Address}} |
    <strong>Type:</strong> {{.ProbeType}} |
    <strong>Interval:</strong> {{.ProbeInterval}}s
</p>

<div class="controls">
    <span>Presets:</span>
    <button onclick="setRange('1h')">Last 1h</button>
    <button onclick="setRange('24h')">Last 24h</button>
    <button onclick="setRange('7d')">Last 7d</button>
    <button onclick="setRange('30d')">Last 30d</button>

    <span style="margin-left: 20px; margin-right: 5px;">Move:</span>
    <button onclick="moveTime(-60)">-1h</button>
    <button onclick="moveTime(-5)">-5m</button>
    <button onclick="moveTime(5)">+5m</button>
    <button onclick="moveTime(60)">+1h</button>

    <span style="margin-left: 20px;">Range:</span>
    <input type="datetime-local" id="start-time">
    <span>to</span>
    <input type="datetime-local" id="end-time">
    <button onclick="updateFromInputs()">Go</button>

    <span style="margin-left: 20px;">Graph Mode: </span>
    <select id="graph-mode" onchange="changeGraphMode(this.value)">
        <option value="heatmap">Heatmap</option>
        <option value="line">Line Chart</option>
    </select>
    <span style="margin-left: 20px;">
        <input type="checkbox" id="show-raw" onchange="loadChart()">
        <label for="show-raw">Show Raw Timings</label>
    </span>
    <span style="margin-left: 20px;">
        <input type="checkbox" id="log-scale" onchange="loadChart()">
        <label for="log-scale">Log Scale</label>
    </span>
</div>

<style>
    #tooltip-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        pointer-events: none;
        font-family: monospace;
        font-size: 12px;
        z-index: 100;
        display: none;
        min-width: 150px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
</style>

<div class="chart-container" style="position: relative;">
    <div id="tooltip-overlay"></div>
    <canvas id="chart"></canvas>
</div>

<script>
    const targetID = {{.ID }};
    let currentGraphMode = 'heatmap';
    let chartInstance = null;

    function setInputs(start, end) {
        document.getElementById('start-time').value = VaporTrail.toLocalISO(start);
        document.getElementById('end-time').value = VaporTrail.toLocalISO(end);
    }

    function getInputs() {
        const s = document.getElementById('start-time').value;
        const e = document.getElementById('end-time').value;
        if (s && e) {
            return { start: new Date(s), end: new Date(e) };
        }
        return null;
    }

    function setRange(range) {
        const end = new Date();
        let start = new Date();
        switch (range) {
            case '1h': start.setTime(end.getTime() - 1 * 60 * 60 * 1000); break;
            case '24h': start.setTime(end.getTime() - 24 * 60 * 60 * 1000); break;
            case '7d': start.setTime(end.getTime() - 7 * 24 * 60 * 60 * 1000); break;
            case '30d': start.setTime(end.getTime() - 30 * 24 * 60 * 60 * 1000); break;
        }
        setInputs(start, end);
        loadChart();
    }

    function moveTime(minutes) {
        const range = getInputs();
        if (!range) return;
        const diff = minutes * 60 * 1000;
        const newStart = new Date(range.start.getTime() + diff);
        const newEnd = new Date(range.end.getTime() + diff);
        setInputs(newStart, newEnd);
        loadChart();
    }

    function updateFromInputs() {
        loadChart();
    }

    function changeGraphMode(mode) {
        currentGraphMode = mode;
        loadChart();
    }

    // Initialize with Last 1h
    window.addEventListener('load', () => {
        setRange('1h');
    });

    async function loadChart() {
        const range = getInputs();
        if (!range) return;

        // 1. Fetch Aggregated Data (Always)
        const aggUrl = '/api/results/' + targetID + '?start=' + range.start.toISOString() + '&end=' + range.end.toISOString();
        const aggRes = await fetch(aggUrl);
        const aggData = await aggRes.json();
        if (!aggData) return;

        let rawData = [];
        const showRaw = document.getElementById('show-raw').checked;

        // 2. Fetch Raw Data (If checked)
        if (showRaw) {
            const rawUrl = aggUrl + '&raw=true';
            const rawRes = await fetch(rawUrl);
            if (!rawRes.ok) {
                if (rawRes.status === 400) {
                    const msg = await rawRes.text();
                    alert(msg);
                    document.getElementById('show-raw').checked = false;
                } else {
                    console.error("Failed to load raw data", rawRes);
                }
            } else {
                rawData = await rawRes.json();
            }
        }

        const canvas = document.getElementById('chart');
        if (chartInstance) {
            chartInstance.destroy();
        }

        const useLogScale = document.getElementById('log-scale').checked;
        const tooltipEl = document.getElementById('tooltip-overlay');

        chartInstance = VaporTrail.renderLatencyChart({
            canvas: canvas,
            data: aggData,
            range: range,
            mode: currentGraphMode,
            useLogScale: useLogScale,
            rawData: rawData,
            tooltipEl: tooltipEl,
            onZoomComplete: function (start, end) {
                setInputs(start, end);
                loadChart();
            }
        });
    }
</script>
{{template "footer" .}}