<!DOCTYPE html>
<html>

<head>
    <title>VaporTrail</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .target {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>VaporTrail Dashboard</h1>
    <button onclick="showAddTarget()">Add Target</button>
    <div id="targets">Loading...</div>

    <div id="add-target-modal"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border:1px solid black; z-index:1000;">
        <h2>Add Target</h2>
        <form id="target-form" onsubmit="submitTarget(event)">
            <input type="hidden" name="id">
            <div>
                <label>Name:</label><br>
                <input type="text" name="name" required>
            </div>
            <div>
                <label>Address:</label><br>
                <input type="text" name="address" required>
            </div>
            <div>
                <label>Probe Type:</label><br>
                <select name="type">
                    <option value="ping">Ping</option>
                    <option value="http">HTTP</option>
                    <option value="dns">DNS</option>
                </select>
            </div>
            <div>
                <label>Probe Interval (s):</label><br>
                <input type="number" name="interval" value="1.0" min="0.1" step="0.1">
            </div>
            <div>
                <label>Commit Interval (s):</label><br>
                <input type="number" name="commit" value="60.0" min="1.0" step="1.0">
            </div>
            <button type="submit">Save</button>
            <button type="button"
                onclick="document.getElementById('add-target-modal').style.display='none'">Cancel</button>
        </form>
    </div>

    <script>

        async function submitTarget(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                Name: formData.get('name'),
                Address: formData.get('address'),
                ProbeType: formData.get('type'),
                ProbeInterval: parseFloat(formData.get('interval')) || 1.0,
                CommitInterval: parseFloat(formData.get('commit')) || 60.0
            };

            const id = formData.get('id');
            let res;
            if (id) {
                res = await fetch('/api/targets/' + id, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } else {
                res = await fetch('/api/targets', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            if (res.ok) {
                document.getElementById('add-target-modal').style.display = 'none';
                loadTargets();
                // We're done, reset form?
                e.target.reset();
            } else {
                alert("Failed to create target");
            }
        }

        async function loadTargets() {
            const res = await fetch('/api/targets');
            const targets = await res.json();
            const div = document.getElementById('targets');
            div.innerHTML = '';

            for (const t of targets) {
                const el = document.createElement('div');
                el.className = 'target';
                const canvasId = 'chart-' + t.ID;
                el.innerHTML = '<h3>' + t.Name + ' (' + t.Address + ') [Interval: ' + t.ProbeInterval + 's] <button onclick="editTarget(' + t.ID + ')" style="font-size: 0.8em; margin-left: 10px;">Edit</button> <button onclick="deleteTarget(' + t.ID + ')" style="color:red; font-size: 0.8em; margin-left: 10px;">Delete</button></h3><div class="chart-container"><canvas id="' + canvasId + '"></canvas></div>';
                div.appendChild(el);
                loadChart(t.ID, canvasId);
            }
        }

        async function editTarget(id) {
            const res = await fetch('/api/targets');
            const targets = await res.json();
            const t = targets.find(x => x.ID === id);
            if (!t) return;

            document.querySelector('#add-target-modal h2').innerText = 'Edit Target';
            document.querySelector('input[name="id"]').value = t.ID;
            document.querySelector('input[name="name"]').value = t.Name;
            document.querySelector('input[name="address"]').value = t.Address;
            document.querySelector('select[name="type"]').value = t.ProbeType;
            document.querySelector('input[name="interval"]').value = t.ProbeInterval;
            document.querySelector('input[name="commit"]').value = t.CommitInterval;

            document.getElementById('add-target-modal').style.display = 'block';
        }

        function showAddTarget() {
            document.querySelector('#add-target-modal h2').innerText = 'Add Target';
            document.querySelector('input[name="id"]').value = '';
            document.getElementById('target-form').reset();
            document.querySelector('input[name="interval"]').value = 1.0;
            document.querySelector('input[name="commit"]').value = 60.0;
            document.getElementById('add-target-modal').style.display = 'block';
        }

        async function deleteTarget(id) {
            if (!confirm("Are you sure you want to delete this target?")) return;
            const res = await fetch('/api/targets/' + id, { method: 'DELETE' });
            if (res.ok) {
                loadTargets();
            } else {
                alert("Failed to delete target");
            }
        }

        async function loadChart(id, canvasId) {
            const end = new Date();
            const start = new Date(end.getTime() - 60 * 60 * 1000); // Last 1 hour

            const url = '/api/results/' + id + '?start=' + start.toISOString() + '&end=' + end.toISOString();
            const res = await fetch(url);
            const data = await res.json();

            if (!data) return;

            const ctx = document.getElementById(canvasId);
            if (!ctx) return; // Canvas might be gone if target deleted
            const context = ctx.getContext('2d');
            const labels = data.map(d => d.Time);

            // P0, P25, P50, P75, P100 (using result's P fields, converted to ms)
            // Fallback to Min/Max/Avg logic if P-fields are missing (though server should send them as 0 if empty)
            const p0Data = data.map(d => (d.P0 || d.MinNS) / 1000000);
            const p25Data = data.map(d => (d.P25) / 1000000);
            const p50Data = data.map(d => (d.P50) / 1000000);
            const p75Data = data.map(d => (d.P75) / 1000000);
            const p100Data = data.map(d => (d.P100 || d.MaxNS) / 1000000);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Max (P100) (ms)', data: p100Data, borderColor: '#FF0000', backgroundColor: '#FF0000', fill: false, tension: 0.1, borderWidth: 1 },
                        { label: 'Q3 (P75) (ms)', data: p75Data, borderColor: '#FF7F00', backgroundColor: '#FF7F00', fill: false, tension: 0.1, borderWidth: 1 },
                        { label: 'Median (P50) (ms)', data: p50Data, borderColor: '#00FF00', backgroundColor: '#00FF00', fill: false, tension: 0.1, borderWidth: 2 },
                        { label: 'Q1 (P25) (ms)', data: p25Data, borderColor: '#0000FF', backgroundColor: '#0000FF', fill: false, tension: 0.1, borderWidth: 1 },
                        { label: 'Min (P0) (ms)', data: p0Data, borderColor: '#4B0082', backgroundColor: '#4B0082', fill: false, tension: 0.1, borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Latency (ms)' } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        loadTargets();
    </script>
</body>

</html>